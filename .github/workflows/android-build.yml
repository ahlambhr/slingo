name: Build Android APK

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    # Use the prebuilt Buildozer image (Android SDK/NDK already inside)
    container:
      image: kivy/buildozer:stable
      options: --privileged

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install essentials inside container
        run: |
          apt-get update
          apt-get install -y git zip unzip
          git --version
          python3 --version
          buildozer --version

      - name: Build APK (debug, verbose)
        env:
          BUILDOZER_WARN_ON_ROOT: "0"
        run: |
          # Clean any previous partial build (optional but keeps CI fresh)
          rm -rf .buildozer bin || true
          # Build with verbose output
          buildozer -v android debug

      # Always upload logs so we can diagnose if anything fails
      - name: Upload Buildozer logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: buildozer-logs
          path: |
            .buildozer/buildozer.log
            .buildozer/android/**/*.log
            .buildozer/android/**/*.txt

      - name: Upload APK
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: slingo-apk
          path: bin/*.apk
